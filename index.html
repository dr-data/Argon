<!doctype html>
<meta charset=utf-8>
<meta name=viewport content="width=device-width, initial-scale=1.0">
<title>sulfurous</title>
<link rel=icon type="image/png" href="favicon.ico">
<link rel=stylesheet href=player.css>
<link rel=stylesheet href=index.css>

<div class=area id=title-area>
  <h1 class=title>sulfurous</h1>
  <p>sulfurous, just like phosphorus, runs your Scratch projects really fast by compiling them to JavaScript. Try it out by pasting a URL or project ID into the field below or <a class=dropdown>choosing an example<select id=examples>
  <option value>
  <option value=11397100>3D Remix by DadOfMrLog
  <option value=15945630>O by DCPU-16
  <option value=10128407>Paper Minecraft by griffpatch
  <option value=16207935>Alone in the depths by sticku
  <option value=16205373>3D Framework by DadOfMrLog
  <option value=31903442>gb.sb2 [Dr. Mario] by DCPU-16
  <option value=34791164>gb.sb2 [Mario Land 2] by DCPU-16
  <option value=21554369>Epic Ninja by griffpatch
  <option value=15832807>Pretty by blob8108
</select></a>. You can also drag a local .sb2 project onto this page.</p>
</div>

<div class=area id=player-area>
  <div class=controls>
    <span class=stop></span>
    <span class=pause></span>
    <span class=flag title="Shift+click to enable turbo mode."></span>
    <div class=turbo>Turbo Mode</div>
    <span class=full-screen></span>
  </div>
  <div class=player></div>
  <div class="formWrapper">
    
    <div id="startButton"><button id="greenFlag" onclick="Argon.player.refresh()">âš‘</button>
    </div>
    <div id="spriteSelection"></div>
    <div id="saveButton"><button onclick="window.makeScript(true)">ðŸ’¾</button>
    </div>
  </div>

  <div id="blocklyDiv" style="height: 480px; width: 900px;"></div>
  <div class=internal-error>
    An internal error occurred. <a id=error-bug-link target=_blank href=https://github.com/mittagskogel/sulfurous/issues/new>Click here</a> to file a bug report.
  </div>
</div>

<div class=title>
  <div class=progress-bar></div>
  <input class=url value=https://scratch.mit.edu/projects/>
  <a target=_blank class=project-link title="View project on Scratch"></a>
</div>

<div class=area id=project-area>

  <section class=package>
    <h1>Package this project</h1>
    <p>Get a link to a web page that automatically runs your project.</p>
    <p>
      <a href=# target=_blank id=package-link>Package</a>
      <input type=checkbox id=package-turbo>
      <label for=package-turbo>Turbo mode</label>
      <input type=radio id=package-full-screen name=custom-resolution>
      <label for=package-full-screen>Full screen</label>
      <br />
      <input type=radio id=package-standard-resolution checked name=custom-resolution>
      <label for=package-standard-resolution>480x360</label>
      <input type=radio id=package-double-resolution name=custom-resolution>
      <label for=package-double-resolution>960x720</label>
      <input type=radio id=package-custom-resolution name=custom-resolution>
      <label for=package-custom-resolution>Custom width:</label>
      <input type=number id=package-custom-resolution-value min=0 max=16000>
    </p>
  </section>
  <section class=package>
    <h1>Embed this project</h1>
    <p>Include the sulfurous player in your web site.</p>
    <p>
      <input readonly id=embed-code>
      <input type=checkbox id=embed-auto-start checked>
      <label for=embed-auto-start>Start automatically</label>
      <input type=checkbox id=embed-light-content>
      <label for=embed-light-content>Light controls</label>
      <input type=checkbox id=embed-hide-controls>
      <label for=embed-hide-controls>Hide UI</label>
      <input type=radio id=embed-standard-resolution name=e-custom-resolution>
      <label for=embed-standard-resolution>480x360</label>
      <input type=radio id=embed-double-resolution name=e-custom-resolution>
      <label for=embed-double-resolution>960x720</label>
      <input type=radio id=embed-custom-resolution name=e-custom-resolution>
      <label for=embed-custom-resolution>Custom width:</label>
      <input type=number id=embed-custom-resolution-value min=0 max=16000>
    </p>
  </section>
  <section>
    <h1>Report a problem</h1>
    <p>sulfurous is still in development. <a id=bug-link target=_blank href=https://github.com/mittagskogel/sulfurous/issues/new>Click here</a> to report a problem with this project.</p>
  </section>
</div>
<section>
  <h1>Credits</h1>
  <p>Sulfurous was created by <a href=https://github.com/mittagskogel>Mittagskogel</a> and is based off Phosphorus, which was created by <a href=https://github.com/nathan>Nathan Dinsmore</a>. Its CPS-style compilation and overall design was inspired by
    <a href=https://github.com/RHY3756547>Rhys Simpson</a>'s <a href=https://code.google.com/p/sb2-js/>sb2.js</a>. It would have more bugs if not for <a href=https://github.com/trumank>Truman Kilen</a>. It uses the <a href=https://stuk.github.io/jszip/>JSZip</a>
    library, created by <a href=https://github.com/stuk>Stuart Knightley</a>,
    <a href=https://github.com/dduponchel>David Duponchel</a>, Franz Buchinger, and <a href=https://github.com/aadsm>AntÃ³nio Afonso</a>, to read <code>.sb2</code> files and compressed projects, and the <a href=https://code.google.com/p/canvg/>canvg</a>
    library, created by <a href=https://code.google.com/u/gabelerner@gmail.com/>Gabe Lerner</a>, to render SVGs in <code>&lt;canvas&gt;</code> elements.
    <h1>Code</h1>
    <p>The source code for sulfurous is available <a href=https://github.com/mittagskogel/sulfurous>on GitHub</a>. See <a href=https://github.com/nathan/phosphorus>Phosphorus</a> for the original version.</p>
</section>
<script src=fonts.js></script>
<!--<script src=https://cdnjs.cloudflare.com/ajax/libs/jszip/2.4.0/jszip.js></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="/blockly_compressed.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
<!--<script src="../blockly/blockly_uncompressed.js"></script>-->
<!--<script src="blockly/blocks_compressed.js"></script>-->
<!--<script src="blockly/msg/js/en.js"></script>-->
<!--<script src="blockly_predefinedVars.js"></script>-->
<script src="blocks_motion.js"></script>
<script src="blocks_data.js"></script>
<script src="blocks_events.js"></script>
<script src="blocks_looks.js"></script>
<script src="blocks_control.js"></script>
<script src="blocks_pen.js"></script>
<script src="blocks_sensing.js"></script>
<script src="blocks_operators.js"></script>
<script src="en.js"></script>
<script src=xml2json.js></script>
<script src=argon.js></script>
<script src=phosphorus.js></script>
<script src=player.js></script>
<script>
  (function() {
    'use strict';

    var prefix = 'https://scratch.mit.edu/projects/';

    var initialId = location.hash.substr(1);
    if (initialId === 'zip') initialId = '';

    var titleArea = document.querySelector('#title-area');
    var playerArea = document.querySelector('#player-area');
    var projectArea = document.querySelector('#project-area');

    playerArea.style.height = projectArea.style.height = 'auto';
    var titleAreaHeight = titleArea.offsetHeight;
    var playerAreaHeight = playerArea.offsetHeight;
    var projectAreaHeight = projectArea.offsetHeight;
    playerArea.style.height = projectArea.style.height = 0;

    var examples = document.querySelector('#examples');
    var urlInput = document.querySelector('.url');
    urlInput.value = prefix + initialId;

    var progressBar = document.querySelector('.progress-bar');
    var player = document.querySelector('.player');
    var projectLink = document.querySelector('.project-link');
    var bugLink = document.querySelector('#bug-link');

    var packageLink = document.querySelector('#package-link');
    var packageTurbo = document.querySelector('#package-turbo');
    var packageFullScreen = document.querySelector('#package-full-screen');
    var packageStandardResolution = document.querySelector('#package-standard-resolution');
    var packageDoubleResolution = document.querySelector('#package-double-resolution');
    var packageCustomResolution = document.querySelector('#package-custom-resolution');
    var packageCustomResolutionValue = document.querySelector('#package-custom-resolution-value');

    var embedCode = document.querySelector('#embed-code');
    var embedAutoStart = document.querySelector('#embed-auto-start');
    var embedLightContent = document.querySelector('#embed-light-content');
    var embedHideControls = document.querySelector('#embed-hide-controls');
    var embedStandardResolution = document.querySelector('#embed-standard-resolution');
    var embedDoubleResolution = document.querySelector('#embed-double-resolution');
    var embedCustomResolution = document.querySelector('#embed-custom-resolution');
    var embedCustomResolutionValue = document.querySelector('#embed-custom-resolution-value');

    var timeout;
    urlInput.addEventListener('input', function() {
      var ss = urlInput.selectionStart;
      var se = urlInput.selectionEnd;
      var url = urlInput.value;
      var id = url.match(/\d+/g) || [''];
      while (id.length > 1 && id.indexOf(P.player.projectId) > -1) {
        id.splice(id.indexOf(P.player.projectId), 1);
      }
      id = id[0];
      urlInput.value = url = prefix + id;
      urlInput.selectionStart = urlInput.selectionEnd = Math.max(prefix.length, ss);
      clearTimeout(timeout);
      if (P.player.projectId !== id) {
        timeout = setTimeout(function() {
          location.hash = '#' + id;
        }, 300);
      }
    });
    urlInput.addEventListener('focus', function() {
      setTimeout(function() {
        if (/\d/.test(urlInput.value)) {
          urlInput.select();
        }
      });
    });

    examples.addEventListener('change', function() {
      if (examples.value) {
        location.hash = '#' + examples.value;
        examples.selectedIndex = 0;
      }
    });

    window.addEventListener('hashchange', function() {
      var id = location.hash.substr(1);
      if (id !== 'zip') {
        if (+id !== +id) id = '';
        urlInput.value = prefix + id;
      }
      load(id);
    });

    function show(id) {
      titleArea.style.height = id ? 0 : titleAreaHeight + 'px';
      playerArea.style.height = id ? playerAreaHeight + 'px' : 0
      projectArea.style.height = id ? projectAreaHeight + 'px' : 0;
      if (!id) urlInput.focus();
    }

    function load(id) {
      if (id !== 'zip') {
        show(id);
      }
      else {
        id = '';
      }

      document.title = 'sulfurous';
      console.log(P.player)
      P.player.load(id, function(stage) {
        stage.triggerGreenFlag();
        // set the method on the Argon player
        Argon.player.reload = stage.triggerGreenFlag;
        // we'll need the stage for context
        Argon.player.stage = stage;
      }, function(title) {
        document.title = title ? title + ' \xb7 sulfurous' : 'sulfurous';
        updateBugLink();
      });

      projectLink.href = P.player.projectURL;
      updateBugLink();
      updatePackageLink();
      updateEmbedCode();
    }

    function updateBugLink() {
      bugLink.href = P.player.projectId ? 'https://github.com/mittagskogel/sulfurous/issues/new?title=' + encodeURIComponent(P.player.projectTitle || P.player.projectURL) + '&body=' + encodeURIComponent('\n\n\n' + P.player.projectURL + '\nhttps://newton.nes.aau.at/~sulfurous/#' + P.player.projectId + '\n' + navigator.userAgent) : 'https://github.com/mittagskogel/sulfurous/issues/new?body=' + encodeURIComponent('\n\n\n' + navigator.userAgent);
    }

    function updatePackageLink() {
      if (packageFullScreen.checked) packageCustomResolutionValue.value = null;
      if (packageStandardResolution.checked) packageCustomResolutionValue.value = 480;
      if (packageDoubleResolution.checked) packageCustomResolutionValue.value = 960;
      //remember to change the URL back to /app.html when putting this back online...
      //packageLink.href = P.player.projectId ? 'file:///D:/Mittagskogel/Sulfurous/app.html?id=' + P.player.projectId + '&turbo=' + packageTurbo.checked + '&full-screen=' + packageFullScreen.checked + '&resolution-x=' + packageCustomResolutionValue.value: 'about:blank';
      packageLink.href = P.player.projectId ? 'https://sulfurous.aau.at/~sulfurous/app.html?id=' + P.player.projectId + '&turbo=' + packageTurbo.checked + '&full-screen=' + packageFullScreen.checked + '&resolution-x=' + packageCustomResolutionValue.value : 'about:blank';
      packageCustomResolutionValue.disabled = !packageCustomResolution.checked;
    }

    packageTurbo.addEventListener('change', updatePackageLink);
    packageFullScreen.addEventListener('change', updatePackageLink);
    packageStandardResolution.addEventListener('change', updatePackageLink);
    packageDoubleResolution.addEventListener('change', updatePackageLink);
    packageCustomResolution.addEventListener('change', updatePackageLink);
    packageCustomResolutionValue.addEventListener('change', updatePackageLink);

    function updateEmbedCode(e) {
      if (embedStandardResolution.checked) embedCustomResolutionValue.value = 480;
      if (embedDoubleResolution.checked) embedCustomResolutionValue.value = 960;
      //remember to change the URL back to 'https://' + location.host when putting this back online...
      //embedCode.value = P.player.projectId ? '<script src=file:///D:/Mittagskogel/Sulfurous' + '/embed.js?id=' + P.player.projectId + '&resolution-x=' + embedCustomResolutionValue.value + (embedHideControls.checked ? '&ui=false' : '&auto-start=' + embedAutoStart.checked + '&light-content=' + embedLightContent.checked) + '></' + 'script>' : '';
      embedCode.value = P.player.projectId ? '<script src=https://sulfurous.aau.at/~sulfurous' + '/embed.js?id=' + P.player.projectId + '&resolution-x=' + embedCustomResolutionValue.value + (embedHideControls.checked ? '&ui=false' : '&auto-start=' + embedAutoStart.checked + '&light-content=' + embedLightContent.checked) + '></' + 'script>' : '';
      embedCustomResolutionValue.disabled = !embedCustomResolution.checked;
      embedAutoStart.disabled =
        embedLightContent.disabled = embedHideControls.checked;
      if (embedHideControls.checked) embedAutoStart.checked = true;
      if (e) embedCode.focus();
    }

    function selectEmbedCode() {
      setTimeout(function() {
        embedCode.select();
      });
    }

    embedCode.addEventListener('focus', selectEmbedCode);
    embedCode.addEventListener('click', selectEmbedCode);
    embedHideControls.addEventListener('change', updateEmbedCode);
    embedAutoStart.addEventListener('change', updateEmbedCode);
    embedLightContent.addEventListener('change', updateEmbedCode);
    embedStandardResolution.addEventListener('change', updateEmbedCode);
    embedDoubleResolution.addEventListener('change', updateEmbedCode);
    embedCustomResolution.addEventListener('change', updateEmbedCode);
    embedCustomResolutionValue.addEventListener('change', updateEmbedCode);

    load(initialId);

    setTimeout(function() {
      function setTransition(el) {
        el.style.WebkitTransition =
          el.style.MozTransition =
          el.style.OTransition =
          el.style.transition = 'height 0.2s';
      }
      setTransition(titleArea);
      setTransition(playerArea);
      setTransition(projectArea);
    });

    function cancel(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
    }
    document.body.addEventListener('dragover', cancel);
    document.body.addEventListener('dragenter', cancel);

    document.body.addEventListener('drop', function(e) {
      e.preventDefault();

      var f = e.dataTransfer.files[0];



      if (f) {
        location.hash = '#zip';
        show('zip');
        var ext = f.name.split('.').pop();
        if (ext === 'sb2' || ext === 'zip') {
          var request = P.IO.loadSB2File(f);
        }
        else if (ext === 'json') {
          request = P.IO.loadJSONFile(f);
        }
        if (request) {
          P.player.showProgress(request, function(stage) {
            stage.triggerGreenFlag();
          });
        }
      }
    });

  }());
</script>
<xml id="toolbox" style="display: none">
  <category name="Motion" colour="225">
    <block type="forward:"></block>
    <block type="turnRight:"></block>
    <block type="turnLeft:"></block>
    <block type="heading:"></block>
    <block type="pointTowards:"></block>
    <block type="gotoX:y:"></block>
    <block type="gotoSpriteOrMouse:"></block>
    <block type="glideSecs:toX:y:elapsed:from:"></block>
    <block type="changeXposBy:"></block>
    <block type="xpos:"></block>
    <block type="changeYposBy:"></block>
    <block type="ypos:"></block>
    <block type="bounceOffEdge"></block>
    <block type="setRotationStyle"></block>
    <block type="xpos"></block>
    <block type="ypos"></block>
    <block type="heading"></block>
  </category>
  <category name="Looks" colour="264">
    <block type="say:duration:elapsed:from:"></block>
    <block type="say:"></block>
    <block type="think:duration:elapsed:from:"></block>
    <block type="think:"></block>
    <block type="show"></block>
    <block type="hide"></block>
    <block type="lookLike:"></block>
    <block type="nextCostume"></block>
    <block type="startScene"></block>
    <block type="changeGraphicEffect:by:"></block>
    <block type="setGraphicEffect:to:"></block>
    <block type="filterReset"></block>
    <block type="changeSizeBy:"></block>
    <block type="setSizeTo:"></block>
    <block type="comeToFront"></block>
    <block type="goBackByLayers:"></block>
    <block type="costumeIndex"></block>
    <block type="sceneName"></block>
    <block type="scale"></block>

  </category>
  <category name="Sound" colour="296">
  </category>
  <category name="Pen" colour="160">
    <block type="clearPenTrails"></block>
    <block type="stampCostume"></block>
    <block type="putPenDown"></block>
    <block type="putPenUp"></block>
    <block type="penColor:"></block>
    <block type="changePenHueBy:"></block>
    <block type="setPenHueTo:"></block>
    <block type="changePenShadeBy:"></block>
    <block type="setPenShadeTo:"></block>
    <block type="changePenSizeBy:"></block>
    <block type="penSize:"></block>
  </category>
  <category name="Data" colour="32">
    <block type="input"></block>
    <block type="colour_input"></block>
    <block type="readVariable"></block>
    <block type="setVar:to:"></block>
    <block type="changeVar:by:"></block>
    <block type="showVariable:"></block>
    <block type="hideVariable:"></block>
    <block type="contentsOfList:"></block>
    <block type="append:toList:"></block>
    <block type="deleteLine:ofList:"></block>
    <block type="insert:at:ofList:"></block>
    <block type="setLine:ofList:to:"></block>
    <block type="getLine:ofList:"></block>
    <block type="lineCountOfList:"></block>
    <block type="list:contains:"></block>
    <block type="showList:"></block>
    <block type="hideList:"></block>
  </category>
  <category name="Events" colour="20">
    <block type="whenGreenFlag"></block>
    <block type="whenKeyPressed"></block>
    <block type="whenSceneStarts"></block>
    <block type="whenSensorGreaterThan"></block>
    <!--<button text="new message.." callbackKey="createEventPressed"></button>-->
    <block type="message"></block>
    <block type="whenIReceive"></block>
    <block type="broadcast:"></block>
    <block type="doBroadcastAndWait"></block>
  </category>
  <category name="Control" colour="43">
    <block type="wait:elapsed:from:"></block>
    <block type="doRepeat"></block>
    <block type="doForever"></block>
    <block type="doIf"></block>
    <block type="doIfElse"></block>
    <block type="doWaitUntil"></block>
    <block type="doUntil"></block>
    <block type="stopScripts"></block>
    <block type="whenCloned"></block>
    <block type="createCloneOf"></block>
    <block type="deleteClone"></block>
  </category>
  <category name="Sensing" colour="200">
    <block type="touching:"></block>
    <block type="touchingColor:"></block>
    <block type="color:sees:"></block>
    <block type="distanceTo:"></block>
    <block type="doAsk"></block>
    <block type="keyPressed:"></block>
    <block type="mousePressed"></block>
    <block type="mouseX"></block>
    <block type="mouseY"></block>
    <block type="soundLevel"></block>
    <block type="senseVideoMotion"></block>
    <block type="setVideoState"></block>
    <block type="setVideoTransparency"></block>
    <block type="timer"></block>
    <block type="timerReset"></block>
    <block type="getAttribute:of:"></block>
    <block type="timeAndDate"></block>
    <block type="timestamp"></block>
    <block type="getUserName"></block>
  </category>
  <category name="Operators" colour="93">
    <block type="+"></block>
    <block type="-"></block>
    <block type="*"></block>
    <block type="/"></block>
    <block type="randomFrom:to:"></block>
    <block type="&lt;"></block>
    <block type="="></block>
    <block type="&gt;"></block>
    <block type="&amp;"></block>
    <block type="|"></block>
    <block type="not"></block>
    <block type="concatenate:with:"></block>
    <block type="letter:of:"></block>
    <block type="stringLength:"></block>
    <block type="%"></block>
    <block type="rounded"></block>
    <block type="computeFunction:of:"></block>
  </category>
  <category name="More blocks" colour="270">
  </category>

</xml>
